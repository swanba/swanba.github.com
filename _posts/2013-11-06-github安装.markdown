---
author: amos
comments: true
date: 2013-11-06 06:00:35+00:00
layout: post
slug: gitbub安装
title: Github安装
description: git
wordpress_id: 1122
categories:
- Miscellaneous
---

###一、部署环境

    RHEL 6.4 x86_64
    gitlab 6.0.1
    安装路径/data/gitlab
    安装用户：gitlab
###二、安装前准备

1、安装git，假如已经安装则忽略这步:

    yum -y install git
2、添加yum repo

添加epel yum repo:

    rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
添加centos yum repo

    vim /etc/yum.repo/centos.repo

    [base]
     
    name=CentOS-$releasever - Base     
    mirrorlist=http://mirrorlist.centos.org/?release=6&arch=x86_64&repo=os
    #baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/
    gpgcheck=0
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
  
 
    #released updates
    [updates]
    name=CentOS-$releasever - Updates
    mirrorlist=http://mirrorlist.centos.org/?release=6&arch=x86_64&repo=updates
    #baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/
    gpgcheck=0
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
 
    #additional packages that may be useful    
    [extras]
    name=CentOS-$releasever - Extras
    mirrorlist=http://mirrorlist.centos.org/?release=6&arch=x86_64&repo=extras
    #baseurl=http://mirror.centos.org/centos/$releasever/extras/$basearch/
    gpgcheck=0
    gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
 

3、创建gitlab用户

    adduser --system --create-home --comment 'GitLab' gitlab
###三、安装rails环境：

1、安装gitlab依赖包：

    yum -y install patch gcc-c++ readline-devel zlib-devel libffi-devel openssl-devel make autoconf automake libtool bison libxml2-devel libxslt-devel libyaml-devel
2、安装rvm：

    curl -L get.rvm.io | bash -s stable 
    source /etc/profile.d/rvm.sh
 
更新rvm仓库为国内淘宝：

    sed -i -e 's/ftp\.ruby-lang\.org\/pub\/ruby/ruby\.taobao\.org\/mirrors\/ruby/g' $rvm_path/config/db
3、安装ruby:

    rvm pkg install libyaml
    rvm install 1.9.3-p392 --with-libyaml-dir=/usr/local/rvm/usr
    rvm --default use 1.9.3-p392
    gem sources --remove https://rubygems.org/
    gem sources -a http://ruby.taobao.org/
    gem install bundler
 

###四、安装gitshell

1、下载最新稳定版本源

 
    su gitlab  
    cd /data/gitlab
    git clone https://github.com/gitlabhq/gitlab-shell.git
    cd gitlab-shell
    git checkout v1.7.1
 

2、设置正确的gitlab仓库

    cd /data/gitlab    
    cp gitlab-shell/config.yml.example gitlab-shell/config.yml     
    vim gitlab-shell/config.yml，修改正确的用户名、仓库路径：     
    user: gitlab
    repos_path: "/data/gitlab/repositories"
    auth_file: "/home/gitlab/.ssh/authorized_keys"
 

运行如下命令安装gitlab-shell

    gitlab-shell/bin/install
###五、安装redis

    su root     
    yum -y install redis     
    service redis start     
    chkconfig redis on
 

###六、下载配置gitlab

1、下载gitlab稳定版本

    su gitlab 
    git clone https://github.com/gitlabhq/gitlabhq.git gitlab
    cd gitlab
    git checkout v6.0.1
 

2、修改gitlab配置

    #cp config/gitlab.yml.example config/gitlab.yml

    #vim config/gitlab.yml 配置正确的host和端口，邮件地址等：

    gitlab:
      host: 192.168.0.27
      port: 8480
      user: gitlab
      email_from: admin@swanba.com
    satellites:
        path: /data/gitlab/gitlab-satellites/
    gitlab_shell:
       repos_path: /data/gitlab/repositories/
       hooks_path: /data/gitlab/gitlab-shell/hooks/
    cp  config/unicorn.rb.example  config/unicorn.rb
    
    #vim config/unicorn.rb 把/home/git替换为/data/gitlab
    
    listen "/data/gitlab/gitlab/tmp/sockets/gitlab.socket", :backlog => 64
######listen 8480, :tcp_nopush => true
######只保留unix socket，不保留端口号

3、配置git配置：

    git config --global user.name  "admin" 
    git config --global user.email "admin@embracesource.com"
 

###七、安装gitlab

1、安装配置数据库postgresql:

    #su root
    #yum install postgresql-devel
    #yum -y install libicu-devel
    #gem install charlock_holmes --version '0.6.9.4'
    #su gitlab
    $cp config/database.yml.postgresql config/database.yml
    $vim config/database.yml
 
修改正确的pg配置：

    production:
     
      adapter: postgresql
      encoding: unicode
      database: gitlabhq_production
      pool: 10
      username: git
      password:
      host: localhost
      port: 5432
2、恢复原来的repositories

把gitlab原来的git文件夹拷贝到/data/gitlab/repositories下。

3、装gitlab

修改gitlab rails的rvm地址,Gemfile文件在/data/gitlab/gitlab目录下：

    vim Gemfile
 
    source "http://ruby.taobao.org
 

/data/gitlab/gitlab目录下执行如下命令安装rails应用依赖包

bundle install --deployment --without development test mysql aws
新建数据库，注意假如数据库存在数据将会被删除：

    bundle exec rake gitlab:setup RAILS_ENV=production
使用已经存在的数据库：

    bundle exec rake db:migrate RAILS_ENV=production   
    bundle exec rake gitlab:env:info RAILS_ENV=production
把gitlab设置为linux服务:

    #cd /data/gitlab/gitlab/lib/support/init.d
 
修改gitlab安装路径和运行用户

    #vim gitlab ：
     
    APP_ROOT="/data/gitlab/gitlab"
    APP_USER="gitlab"
    #su root  
    #cp  /data/gitlab/gitlab/lib/support/init.d/gitlab  /etc/init.d/
 

###八、gitlab的root_url改为/gitlab:

    config/gitlab.yaml:relative_url_root: /gitlab
    config/application.rb:config.relative_url_root = "/gitlab"
    config/unicorn.rb：ENV['RAILS_RELATIVE_URL_ROOT']="/gitlab"
 

###九、解决gitlab提交大文件的问题

gitlab默认提交的大小是5mb，假如单次提交的大小超过这个则无法提交成功，需要加大这个值。在conf/gitlab.yaml，找到max_sizex和timeout，改为为500mb和100s：

    git:
    bin_path: /usr/bin/git
    # Max size of a git object (e.g. a commit), in bytes
    # This value can be increased if you have very large commits
    max_size: 524288000 # 5.megabytes
    # Git timeout to read a commit, in seconds
    timeout: 100
同时还要修改nginx的client_max_body_size为500mb

git客户端配置如下：

    git config --global http.postbuffer 52428800
 